<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 翻譯字幕播放器 (進階版)</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }
        .config-section { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { font-weight: bold; display: block; margin-top: 10px; }
        input, textarea, select { width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        
        .setting-row { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .setting-item { flex: 1; min-width: 150px; }

        button { padding: 12px 24px; background: #ff0000; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 16px; width: 100%; transition: 0.3s; }
        button:hover { background: #cc0000; }

        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            background: #000;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
        }
        #player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        #subtitle-overlay {
            position: absolute;
            left: 50%;
            bottom: 8%;
            transform: translateX(-50%);
            max-width: 90%;
            text-align: center;
            /* 預設樣式，會被 JS 動態覆蓋 */
            font-size: 24px;
            color: #ffffff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9), -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            padding: 5px 15px;
            pointer-events: none;
            z-index: 10;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>YouTube 翻譯字幕播放器</h1>
    
    <div class="config-section">
        <label>YouTube 網址：</label>
        <input type="text" id="youtube-url" placeholder="貼上網址，例如: https://www.youtube.com/watch?v=xxxx">
        
        <label>字幕內容 (格式: (分:秒-分:秒)內容):</label>
        <textarea id="subtitles" rows="6" placeholder="(00:01-00:03)嘿！你好！&#10;(00:04-00:06)這是一段自訂字幕"></textarea>

        <div class="setting-row">
            <div class="setting-item">
                <label>文字顏色：</label>
                <input type="color" id="font-color" value="#ffffff">
            </div>
            <div class="setting-item">
                <label>字體大小：<span id="size-val">24</span>px</label>
                <input type="range" id="font-size" min="16" max="60" value="24">
            </div>
            <div class="setting-item">
                <label>時間調整 (秒)：</label>
                <input type="number" id="time-offset" value="0" step="0.1" placeholder="正數延後，負數提前">
            </div>
        </div>
        
        <button onclick="loadVideo()">載入影片與字幕</button>
    </div>

    <div class="video-container">
        <div id="player"></div>
        <div id="subtitle-overlay"></div>
    </div>

    <script>
        let player;
        let subtitles = [];
        let subtitleInterval;

        // 即時預覽樣式調整
        const overlay = document.getElementById('subtitle-overlay');
        const sizeSlider = document.getElementById('font-size');
        const colorPicker = document.getElementById('font-color');
        const sizeValText = document.getElementById('size-val');

        sizeSlider.addEventListener('input', () => {
            overlay.style.fontSize = sizeSlider.value + 'px';
            sizeValText.textContent = sizeSlider.value;
        });

        colorPicker.addEventListener('input', () => {
            overlay.style.color = colorPicker.value;
        });

        function loadYouTubeAPI() {
            if (window.YT) return;
            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            document.head.appendChild(tag);
        }

        function getVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function parseSubtitles(text) {
            subtitles = [];
            const offset = parseFloat(document.getElementById('time-offset').value) || 0;
            const lines = text.trim().split('\n');
            
            lines.forEach(line => {
                const match = line.match(/\((\d+):(\d+)-(\d+):(\d+)\)\s*(.*)/);
                if (match) {
                    const start = (parseInt(match[1]) * 60 + parseInt(match[2])) + offset;
                    const end = (parseInt(match[3]) * 60 + parseInt(match[4])) + offset;
                    subtitles.push({ start, end, text: match[5] });
                }
            });
        }

        function updateSubtitles() {
            if (!player || typeof player.getCurrentTime !== 'function') return;
            const currentTime = player.getCurrentTime();
            let activeSubtitle = '';
            
            for (let sub of subtitles) {
                if (currentTime >= sub.start && currentTime < sub.end) {
                    activeSubtitle = sub.text;
                    break;
                }
            }
            overlay.textContent = activeSubtitle;
            // 如果沒字幕就隱藏背景感，有的話顯示
            overlay.style.display = activeSubtitle ? 'block' : 'none';
        }

        function loadVideo() {
            loadYouTubeAPI();
            const url = document.getElementById('youtube-url').value;
            const videoId = getVideoId(url);
            if (!videoId) return alert('請輸入正確的 YouTube 網址');

            parseSubtitles(document.getElementById('subtitles').value);
            
            // 初始化樣式
            overlay.style.fontSize = sizeSlider.value + 'px';
            overlay.style.color = colorPicker.value;

            if (player) player.destroy();

            player = new YT.Player('player', {
                videoId: videoId,
                playerVars: { 'playsinline': 1, 'controls': 1 },
                events: {
                    'onReady': (e) => {
                        if (subtitleInterval) clearInterval(subtitleInterval);
                        subtitleInterval = setInterval(updateSubtitles, 100);
                    },
                    'onStateChange': (e) => {
                        if (e.data === YT.PlayerState.PLAYING) {
                            if (subtitleInterval) clearInterval(subtitleInterval);
                            subtitleInterval = setInterval(updateSubtitles, 100);
                        } else {
                            clearInterval(subtitleInterval);
                        }
                    }
                }
            });
        }

        function onYouTubeIframeAPIReady() {}
    </script>
</body>
</html>
