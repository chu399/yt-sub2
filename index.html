<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 翻譯字幕播放器</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        input, textarea { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; }
        button { padding: 10px 20px; background: #ff0000; color: white; border: none; cursor: pointer; }
        button:hover { background: #cc0000; }
        .video-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            margin: 20px 0;
            /* 16:9 比例盒子 */
            padding-top: 56.25%;
            background: #000;
        }
        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #subtitle-overlay {
            position: absolute;
            left: 50%;
            bottom: 5%;
            transform: translateX(-50%);
            max-width: 90%;
            text-align: center;
            font-size: 24px;
            line-height: 1.4;
            color: #fff;
            text-shadow: 0 0 4px #000, 0 0 8px #000;
            padding: 6px 10px;
            border-radius: 6px;
            pointer-events: none; /* 不擋點擊影片 */
        }
        .controls { text-align: center; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>YouTube 翻譯字幕播放器</h1>
    <label>輸入 YouTube 網址：</label>
    <input type="text" id="youtube-url" placeholder="例如: https://www.youtube.com/watch?v=VIDEO_ID">
    
    <label>貼上字幕 (格式: (分:秒-分:秒)翻譯字幕，每行一條):</label>
    <textarea id="subtitles" rows="10" placeholder="(00:01-00:03)這是第一條字幕
(00:04-00:06)第二條字幕"></textarea>
    
    <div class="controls">
        <button onclick="loadVideo()">載入影片與字幕</button>
    </div>
    
    <div class="video-container">
        <div id="player"></div>
        <div id="subtitle-overlay"></div>
    </div>

    <script>
        let player;
        let subtitles = [];
        let subtitleInterval;

        // 載入 YouTube IFrame API [web:6]
        function loadYouTubeAPI() {
            if (typeof YT === 'object' && YT.Player) return;
            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        // 解析 YouTube URL 取得 video ID [web:16]
        function getVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return match && match[2].length === 11 ? match[2] : null;
        }

        // 解析字幕格式並轉換時間為秒
        // 格式: (mm:ss-mm:ss)文字
        function parseSubtitles(text) {
            subtitles = [];
            const lines = text.trim().split('\n');
            lines.forEach(line => {
                const match = line.match(/\((\d+):(\d+)-(\d+):(\d+)\)\s*(.*)/);
                if (match) {
                    const startMin = parseInt(match[1], 10), startSec = parseInt(match[2], 10);
                    const endMin = parseInt(match[3], 10), endSec = parseInt(match[4], 10);
                    const caption = match[5];
                    subtitles.push({
                        start: startMin * 60 + startSec,
                        end: endMin * 60 + endSec,
                        text: caption
                    });
                }
            });
        }

        // 更新字幕顯示（壓在影片上）
        function updateSubtitles() {
            if (!player || !subtitles.length || typeof player.getCurrentTime !== 'function') return;
            const currentTime = player.getCurrentTime();
            let activeSubtitle = '';
            for (let sub of subtitles) {
                if (currentTime >= sub.start && currentTime < sub.end) {
                    activeSubtitle = sub.text;
                    break;
                }
            }
            document.getElementById('subtitle-overlay').textContent = activeSubtitle;
        }

        function loadVideo() {
            loadYouTubeAPI();
            const url = document.getElementById('youtube-url').value;
            const subsText = document.getElementById('subtitles').value;
            const videoId = getVideoId(url);
            if (!videoId) {
                alert('無效的 YouTube 網址');
                return;
            }
            parseSubtitles(subsText);
            if (player && typeof player.destroy === 'function') player.destroy();
            player = new YT.Player('player', {
                width: '100%',
                height: '100%',
                videoId: videoId,
                playerVars: {
                    playsinline: 1,
                    enablejsapi: 1,
                    controls: 1
                },
                events: {
                    onReady: onPlayerReady,
                    onStateChange: onPlayerStateChange
                }
            });
        }

        function onYouTubeIframeAPIReady() {
            // 由 API 呼叫，這裡不用做事
        }

        function onPlayerReady() {
            if (subtitleInterval) clearInterval(subtitleInterval);
            subtitleInterval = setInterval(updateSubtitles, 100); // 每 100ms 更新一次 [web:17]
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                if (subtitleInterval) clearInterval(subtitleInterval);
                subtitleInterval = setInterval(updateSubtitles, 100);
            } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                if (subtitleInterval) clearInterval(subtitleInterval);
                // 停止時可以保留最後一句，也可以清掉，看你喜好：
                // document.getElementById('subtitle-overlay').textContent = '';
            }
        }
    </script>
</body>
</html>
